<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å¿ƒåŠ¨æ·˜æ±°èµ›</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body { 
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; 
  text-align: center; 
  background: #fafafa;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding: 6px;
  position: relative;
}

h1 {
  margin: 0 0 4px;
  font-size: clamp(1.5em, 5vw, 2.2em);
  color: #ff6b9d;
  flex-shrink: 0;
}

#status {
  margin: 0 0 6px;
  font-size: clamp(1em, 4vw, 1.3em);
  min-height: 1.8em;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #555;
  flex-shrink: 0;
  padding: 0 5px;
}

.images-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 2px;
  margin: 0 0 4px;
  flex: 1;
  width: 100%;
  min-height: 140px;
}

.image-wrapper {
  flex: 1;
  max-width: 49.8%;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

img {
  width: auto;
  height: 100%;
  max-width: 100%;
  object-fit: scale-down;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

img:hover {
  transform: scale(1.01);
  box-shadow: 0 3px 8px rgba(255,105,180,0.3);
}

.controls {
  margin: 4px 0 0;
  min-height: 36px;
  flex-shrink: 0;
}

#winnerBanner {
  font-size: 1.5em;
  margin: 12px 0;
  display: none;
}

#reviveBtn {
  display: none;
  margin: 4px auto;
  padding: 7px 16px;
  font-size: 0.95em;
  cursor: pointer;
  border-radius: 16px;
  border: none;
  background: linear-gradient(135deg, #ffb6c1, #ffd1dc);
  color: #333;
  font-weight: 500;
}

/* å…¨çƒç»Ÿè®¡æŒ‰é’® */
#globalStatsBtn {
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: linear-gradient(135deg, #36c, #69c);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 15px;
  font-size: 0.85em;
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 3px 10px rgba(51,102,204,0.3);
  transition: all 0.3s;
}

#globalStatsBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(51,102,204,0.4);
}

#globalStatsPanel {
  position: fixed;
  bottom: 50px;
  left: 10px;
  width: 300px;
  max-height: 400px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  z-index: 100;
  padding: 15px;
  display: none;
  border: 2px solid #36c;
  overflow-y: auto;
}

#globalStatsPanel h3 {
  margin: 0 0 12px;
  color: #36c;
  font-size: 1.1em;
  text-align: center;
}

.stat-item {
  margin: 8px 0;
  padding: 6px;
  border-radius: 8px;
  background: #f8f9ff;
  display: flex;
  align-items: center;
}

.stat-rank {
  width: 24px;
  height: 24px;
  background: #36c;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8em;
  margin-right: 10px;
  flex-shrink: 0;
}

.stat-rank.gold { background: gold; color: #333; }
.stat-rank.silver { background: #c0c0c0; }
.stat-rank.bronze { background: #cd7f32; }

.stat-img {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  margin-right: 10px;
  object-fit: cover;
  border: 2px solid #ddd;
  flex-shrink: 0;
}

.stat-info {
  flex: 1;
}

.stat-name {
  font-size: 0.9em;
  font-weight: 500;
  margin-bottom: 2px;
}

.stat-votes {
  font-size: 0.8em;
  color: #666;
}

#totalVotes {
  text-align: center;
  margin: 10px 0;
  padding-top: 10px;
  border-top: 1px dashed #ddd;
  font-size: 0.9em;
  color: #36c;
  font-weight: bold;
}

.loading {
  text-align: center;
  color: #888;
  padding: 20px;
}

.confetti {
  position: fixed;
  width: 8px;
  height: 8px;
  top: -10px;
  z-index: 9999;
  pointer-events: none;
  animation: fall linear forwards;
}

@keyframes fall {
  from { transform: translateY(0) rotate(0deg); }
  to { transform: translateY(100vh) rotate(360deg); }
}

.flash {
  animation: flash 0.5s 6 alternate;
  box-shadow: 0 0 20px gold !important;
}

@keyframes flash {
  from { box-shadow: 0 0 5px gold; }
  to { box-shadow: 0 0 25px gold; }
}

.winner-image {
  max-width: 80%;
  max-height: 60vh;
  border-radius: 10px;
  margin: 8px auto;
  object-fit: scale-down;
}

@media (max-width: 767px) and (orientation: portrait) {
  body {
    padding: 4px;
  }
  
  .images-container {
    gap: 1px;
  }
  
  img {
    border-radius: 3px;
  }
  
  #globalStatsPanel {
    width: calc(100vw - 20px);
    left: 10px;
    bottom: 50px;
  }
}
</style>
</head>
<body>

<h1>ğŸ’— å¿ƒåŠ¨æ·˜æ±°èµ› ğŸ’—</h1>
<div id="status">æ¥å§ï¼Œç¬¬ä¸€çœ¼â€”â€”ä½ å¯¹è°æœ€å¿ƒåŠ¨ï¼Ÿ</div>

<div class="images-container">
  <div class="image-wrapper">
    <img id="img1" src="">
  </div>
  <div class="image-wrapper">
    <img id="img2" src="">
  </div>
</div>

<div class="controls">
  <button id="reviveBtn">ç­‰ç­‰æˆ‘åæ‚”äº†ï¼Œå†ç»™å¥¹ä¸€æ¬¡æœºä¼š ğŸ˜­</button>
  <div id="winnerBanner"></div>
</div>

<button id="globalStatsBtn">ğŸŒ å…¨çƒæ¦œ</button>
<div id="globalStatsPanel">
  <h3>ğŸŒ å…¨çƒå¿ƒåŠ¨æ’è¡Œæ¦œ</h3>
  <div id="statsList" class="loading">æ­£åœ¨åŠ è½½å…¨çƒæ•°æ®...</div>
  <div id="totalVotes">æ€»æŠ•ç¥¨æ•°ï¼š--</div>
</div>

<audio id="bgMusic" loop volume="0.35">
  <source src="bgmusic.mp3" type="audio/mpeg">
  <source src="bgmusic.m4a" type="audio/m4a">
</audio>

<script>
// ===== Firebase é…ç½® =====
const firebaseConfig = {
  apiKey: "AIzaSyCFykLGib_3YKORCONFthXMDgJYbl0L9QQ",
  authDomain: "water-6a6f2.firebaseapp.com",
  projectId: "water-6a6f2",
  storageBucket: "water-6a6f2.firebasestorage.app",
  messagingSenderId: "533073759068",
  appId: "1:533073759068:web:cd2fe9fd587faaefc18f99"
};

// åˆå§‹åŒ– Firebase
try {
  firebase.initializeApp(firebaseConfig);
  console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸï¼');
} catch (err) {
  console.log('Firebaseåˆå§‹åŒ–:', err.message);
}

const db = firebase.firestore();

// ===== æ¸¸æˆå‚æ•° =====
const totalImages = 70;
const images = Array.from({length: totalImages}, (_, i) => `${String(i + 1).padStart(3, "0")}.jpg`);

// æ¸¸æˆçŠ¶æ€
let poolA = [...images];
let winnersPool = [];
let currentPair = [];
let lastLoser = null;
let reviveUsed = false;
let streakPlayer = null;
let streak = 0;
let firstClickDone = false;
let gameState = 'initial';

// DOMå…ƒç´ 
const img1 = document.getElementById('img1');
const img2 = document.getElementById('img2');
const status = document.getElementById('status');
const reviveBtn = document.getElementById('reviveBtn');
const winnerBanner = document.getElementById('winnerBanner');
const bgMusic = document.getElementById('bgMusic');

// ===== æ¸¸æˆæ ¸å¿ƒå‡½æ•° =====
function calculateImageHeight() {
  const windowHeight = window.innerHeight;
  const windowWidth = window.innerWidth;
  const isLandscape = windowWidth > windowHeight;
  
  const headerHeight = document.querySelector('h1').offsetHeight;
  const statusHeight = document.getElementById('status').offsetHeight;
  const controlsHeight = document.querySelector('.controls').offsetHeight;
  
  const padding = isLandscape ? 20 : 25;
  const availableHeight = windowHeight - headerHeight - statusHeight - controlsHeight - padding;
  
  let imageHeight;
  
  if (isLandscape) {
    if (windowWidth >= 768) {
      imageHeight = Math.min(availableHeight * 0.95, windowHeight * 0.75);
      imageHeight = Math.max(imageHeight, 320);
    } else {
      imageHeight = Math.min(availableHeight * 0.92, windowHeight * 0.70);
      imageHeight = Math.max(imageHeight, 240);
    }
  } else {
    if (windowWidth >= 768) {
      imageHeight = Math.min(availableHeight * 0.85, windowHeight * 0.65);
      imageHeight = Math.max(imageHeight, 260);
    } else {
      imageHeight = Math.min(availableHeight * 0.80, windowHeight * 0.60);
      imageHeight = Math.max(imageHeight, 190);
    }
  }
  
  const wrappers = document.querySelectorAll('.image-wrapper');
  wrappers.forEach(wrapper => {
    wrapper.style.height = `${imageHeight}px`;
  });
  
  return imageHeight;
}

function adjustImageDisplay() {
  setTimeout(() => {
    const images = [img1, img2];
    images.forEach(img => {
      if (img.complete && img.naturalHeight > 0) {
        img.style.objectFit = 'scale-down';
      }
    });
  }, 100);
}

function confettiEffect(count = 40) {
  for (let i = 0; i < count; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + 'vw';
    c.style.background = `hsl(${Math.random() * 360}, 70%, 65%)`;
    c.style.animationDuration = (2 + Math.random() * 1.2) + 's';
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 3000);
  }
}

document.body.addEventListener('click', () => {
  if (!firstClickDone) {
    firstClickDone = true;
    bgMusic.volume = 0.35;
    bgMusic.play().catch(() => {});
    confettiEffect(15);
  }
}, {once: true});

function getRandomPair(arr) {
  if (arr.length < 2) return arr;
  const idx1 = Math.floor(Math.random() * arr.length);
  let idx2 = Math.floor(Math.random() * (arr.length - 1));
  if (idx2 >= idx1) idx2++;
  return [arr[idx1], arr[idx2]];
}

function updateGameState() {
  if (poolA.length === 0 && winnersPool.length === 0) {
    gameState = 'finished';
  } else if (poolA.length >= 2) {
    gameState = 'poolA_vs_poolA';
  } else if (poolA.length === 1 && winnersPool.length > 0) {
    gameState = 'poolA_vs_winnersPool';
  } else if (winnersPool.length >= 2) {
    gameState = 'winnersPool_vs_winnersPool';
  } else if (winnersPool.length === 1 && poolA.length === 0) {
    showChampion(winnersPool[0]);
    return;
  }
  
  selectNextPair();
}

function selectNextPair() {
  if (gameState === 'finished') return;
  
  if (gameState === 'poolA_vs_poolA') {
    currentPair = getRandomPair(poolA);
    status.textContent = `åˆé‡å¿ƒåŠ¨ ${poolA.length} å¼ å¾…é€‰`;
  } else if (gameState === 'poolA_vs_winnersPool') {
    const fromPoolA = poolA[0];
    const fromWinners = winnersPool[Math.floor(Math.random() * winnersPool.length)];
    currentPair = [fromPoolA, fromWinners];
    status.textContent = `æ–°é¢å­” vs å¿ƒåŠ¨è€å‹`;
  } else if (gameState === 'winnersPool_vs_winnersPool') {
    currentPair = getRandomPair(winnersPool);
    status.textContent = `å¼ºå¼ºå¯¹å†³ ${winnersPool.length} ä½å¿ƒåŠ¨é€‰æ‰‹`;
  }
  
  img1.src = currentPair[0];
  img2.src = currentPair[1];
  
  if (lastLoser && !reviveUsed) {
    reviveBtn.style.display = 'inline';
  }
}

function selectImage(idx) {
  const winner = currentPair[idx];
  const loser = currentPair[1 - idx];
  
  if (!winnersPool.includes(winner)) {
    winnersPool.push(winner);
  }
  
  if (poolA.includes(loser)) {
    poolA = poolA.filter(img => img !== loser);
  }
  if (winnersPool.includes(loser)) {
    winnersPool = winnersPool.filter(img => img !== loser);
  }
  
  if (poolA.includes(winner)) {
    poolA = poolA.filter(img => img !== winner);
  }
  
  lastLoser = loser;
  
  if (streakPlayer === winner) {
    streak++;
  } else {
    streakPlayer = winner;
    streak = 1;
  }
  
  if (streak % 10 === 0) {
    confettiEffect(80);
    status.textContent = `å¤©å‘ï¼å·²ç»è¿ç»­ ${streak} æ¬¡ä¸ºå¥¹å¿ƒåŠ¨ ğŸ’˜`;
  } else {
    status.textContent = `å·²è¿ç»­ ${streak} æ¬¡é€‰æ‹©å¥¹ ğŸ’“`;
  }
  
  updateGameState();
}

reviveBtn.onclick = () => {
  if (lastLoser && !reviveUsed) {
    poolA.push(lastLoser);
    reviveUsed = true;
    reviveBtn.style.display = 'none';
    status.textContent = 'å¥¹å¸¦ç€ä½ çš„å¿ƒæ„å›æ¥äº† ğŸ’–';
    confettiEffect(12);
    
    if (currentPair.includes(lastLoser)) {
      const flashImg = currentPair[0] === lastLoser ? img1 : img2;
      flashImg.classList.add('flash');
      setTimeout(() => flashImg.classList.remove('flash'), 3000);
    }
  }
}

// ===== Firebaseç»Ÿè®¡å‡½æ•° =====
async function submitToGlobalStats(imageName) {
  try {
    await db.collection('votes').add({
      image: imageName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });
    console.log('âœ… é€‰æ‹©å·²æäº¤åˆ°å…¨çƒç»Ÿè®¡');
    return true;
  } catch (error) {
    console.error('æäº¤å¤±è´¥:', error);
    const localData = JSON.parse(localStorage.getItem('heartGlobalStats') || '{"total":0,"rankings":{}}');
    localData.total = (localData.total || 0) + 1;
    localData.rankings[imageName] = (localData.rankings[imageName] || 0) + 1;
    localStorage.setItem('heartGlobalStats', JSON.stringify(localData));
    return false;
  }
}

async function loadGlobalStats() {
  try {
    const votesSnapshot = await db.collection('votes').get();
    const totalVotes = votesSnapshot.size;
    
    const voteCounts = {};
    votesSnapshot.forEach(doc => {
      const data = doc.data();
      const image = data.image;
      voteCounts[image] = (voteCounts[image] || 0) + 1;
    });
    
    const rankings = Object.entries(voteCounts)
      .map(([image, votes]) => ({
        image,
        name: `å¿ƒåŠ¨${image.replace('.jpg', '')}å·`,
        votes
      }))
      .sort((a, b) => b.votes - a.votes)
      .slice(0, 10);
    
    return {
      total: totalVotes,
      rankings,
      lastUpdated: new Date().toISOString()
    };
  } catch (error) {
    console.error('è·å–å…¨çƒæ•°æ®å¤±è´¥:', error);
    return getLocalStats();
  }
}

function getLocalStats() {
  const localData = JSON.parse(localStorage.getItem('heartGlobalStats') || '{"total":0,"rankings":{}}');
  
  const rankings = Object.entries(localData.rankings || {})
    .map(([image, votes]) => ({
      image,
      name: `å¿ƒåŠ¨${image.replace('.jpg', '')}å·`,
      votes
    }))
    .sort((a, b) => b.votes - a.votes)
    .slice(0, 5);
  
  return {
    total: localData.total || 0,
    rankings,
    lastUpdated: new Date().toISOString()
  };
}

let unsubscribeStats = null;

function startRealtimeUpdates() {
  if (unsubscribeStats) {
    unsubscribeStats();
  }
  
  unsubscribeStats = db.collection('votes')
    .orderBy('timestamp', 'desc')
    .limit(1)
    .onSnapshot((snapshot) => {
      if (document.getElementById('globalStatsPanel').style.display === 'block') {
        updateStatsDisplay();
      }
    }, (error) => {
      console.error('å®æ—¶ç›‘å¬å¤±è´¥:', error);
    });
}

async function updateStatsDisplay() {
  try {
    document.getElementById('statsList').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æœ€æ–°æ•°æ®...</div>';
    
    const stats = await loadGlobalStats();
    
    document.getElementById('totalVotes').textContent = 
      `æ€»æŠ•ç¥¨æ•°ï¼š${stats.total.toLocaleString()} ç¥¨`;
    
    if (stats.rankings.length === 0) {
      document.getElementById('statsList').innerHTML = 
        '<div class="loading">æš‚æ— æ•°æ®ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªæŠ•ç¥¨è€…å§ï¼</div>';
      return;
    }
    
    const rankingsHtml = stats.rankings.map((item, index) => `
      <div class="stat-item">
        <div class="stat-rank ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">
          ${index + 1}
        </div>
        <img src="${item.image}" class="stat-img" alt="${item.name}" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNGRkYiLz48dGV4dCB4PSIyMCIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjQiPuaXoOazlea3tDwvdGV4dD48L3N2Zz4='">
        <div class="stat-info">
          <div class="stat-name">${item.name}</div>
          <div class="stat-votes">${item.votes.toLocaleString()} ç¥¨</div>
        </div>
      </div>
    `).join('');
    
    document.getElementById('statsList').innerHTML = rankingsHtml;
    
  } catch (error) {
    console.error('æ›´æ–°æ˜¾ç¤ºå¤±è´¥:', error);
    document.getElementById('statsList').innerHTML = 
      '<div class="loading">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
  }
}

// ===== ä¿®æ”¹åçš„showChampionå‡½æ•° =====
async function showChampion(img) {
  gameState = 'finished';
  img1.style.display = 'none';
  img2.style.display = 'none';
  reviveBtn.style.display = 'none';
  status.style.display = 'none';
  
  winnerBanner.style.display = 'block';
  winnerBanner.innerHTML = `
    <div style="margin-bottom: 8px; font-weight: bold;">
      ğŸ‰ æœ€ç»ˆèƒœå‡ºï¼å¥¹å°±æ˜¯ä½ çš„å¿ƒé€‰ ğŸ‰
    </div>
    <img src="${img}" class="winner-image">
    <div style="margin-top: 8px; font-size: 0.9em;">
      è¿èƒœè®°å½•ï¼š${streak} æ¬¡<br>
      <span style="color: #36c; font-size: 0.8em;">âœ¨ ä½ çš„é€‰æ‹©å·²åŠ å…¥å…¨çƒç»Ÿè®¡</span>
    </div>
  `;
  
  await submitToGlobalStats(img);
  
  confettiEffect(150);
  bgMusic.pause();
}

// ===== ç»Ÿè®¡é¢æ¿äº¤äº’ =====
document.getElementById('globalStatsBtn').addEventListener('click', async function() {
  const panel = document.getElementById('globalStatsPanel');
  if (panel.style.display === 'block') {
    panel.style.display = 'none';
    if (unsubscribeStats) {
      unsubscribeStats();
      unsubscribeStats = null;
    }
  } else {
    panel.style.display = 'block';
    await updateStatsDisplay();
    startRealtimeUpdates();
  }
});

document.addEventListener('click', function(event) {
  const panel = document.getElementById('globalStatsPanel');
  const btn = document.getElementById('globalStatsBtn');
  
  if (panel.style.display === 'block' && 
      !panel.contains(event.target) && 
      !btn.contains(event.target)) {
    panel.style.display = 'none';
    if (unsubscribeStats) {
      unsubscribeStats();
      unsubscribeStats = null;
    }
  }
});

// ===== ç»‘å®šç‚¹å‡»äº‹ä»¶ =====
img1.onclick = () => selectImage(0);
img2.onclick = () => selectImage(1);

// ===== å¯åŠ¨æ¸¸æˆ =====
updateGameState();

window.addEventListener('resize', () => {
  calculateImageHeight();
  adjustImageDisplay();
});

window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    calculateImageHeight();
    adjustImageDisplay();
  }, 150);
});

setTimeout(() => {
  calculateImageHeight();
  adjustImageDisplay();
}, 50);

setTimeout(startRealtimeUpdates, 2000);
</script>
</body>
</html>
